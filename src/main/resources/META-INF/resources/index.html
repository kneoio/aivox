<!DOCTYPE html>
<html>
<head>
    <title>HLS Test Player</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial, sans-serif; margin: 24px; }
        .row { margin: 12px 0; }
        input[type="text"] { width: min(900px, 100%); padding: 8px; }
        button { padding: 8px 12px; }
        #status { white-space: pre-wrap; margin-top: 12px; }
    </style>
</head>
<body>

<h1>HLS Test Player</h1>

<div class="row">
    <label for="src">HLS URL (.m3u8):</label>
</div>

<div class="row">
    <input id="src" type="text" spellcheck="false" />
    <button id="load" type="button">Load</button>
</div>

<div class="row">
    <audio id="audio" controls autoplay style="width: min(900px, 100%);"></audio>
</div>

<div id="status"></div>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script>
    const audio = document.getElementById('audio');
    const srcInput = document.getElementById('src');
    const loadBtn = document.getElementById('load');
    const statusEl = document.getElementById('status');

    const params = new URLSearchParams(window.location.search);
    const defaultSrc = params.get('src') || 'http://localhost:38798/api/stream/lumisonic/stream.m3u8';
    srcInput.value = defaultSrc;

    let hls;

    function setStatus(msg) {
        statusEl.textContent = msg || '';
    }

    function load(src) {
        setStatus('Loading: ' + src);

        if (hls) {
            hls.destroy();
            hls = undefined;
        }

        if (audio.canPlayType('application/vnd.apple.mpegurl')) {
            audio.src = src;
            audio.play().catch(() => {});
            setStatus('Using native HLS support');
            return;
        }

        if (window.Hls && window.Hls.isSupported()) {
            hls = new Hls({
                debug: true,
                enableWorker: true,
                manifestLoadingTimeOut: 10000,
                manifestLoadingMaxRetry: 3,
                manifestLoadingRetryDelay: 1000,
                levelLoadingTimeOut: 10000,
                levelLoadingMaxRetry: 4,
                levelLoadingRetryDelay: 1000,
                fragLoadingTimeOut: 20000,
                fragLoadingMaxRetry: 6,
                fragLoadingRetryDelay: 1000,
                xhrSetup: function(xhr, url) {
                    xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
                }
            });
            hls.loadSource(src);
            hls.attachMedia(audio);

            hls.on(Hls.Events.MANIFEST_PARSED, function (event, data) {
                setStatus('Manifest parsed. Levels: ' + data.levels.length);
                audio.play().catch(() => {});
            });

            hls.on(Hls.Events.LEVEL_LOADED, function (event, data) {
                console.log('Level loaded:', data);
            });

            hls.on(Hls.Events.FRAG_LOADED, function (event, data) {
                console.log('Fragment loaded:', data.frag.url);
            });

            hls.on(Hls.Events.ERROR, function (event, data) {
                const msg = 'Error: ' + data.type + ' / ' + data.details + 
                    (data.fatal ? ' (FATAL)' : '') +
                    (data.response ? '\nHTTP ' + data.response.code + ': ' + data.response.text : '') +
                    (data.url ? '\nURL: ' + data.url : '');
                setStatus(msg);
                console.error('HLS error:', data);
                
                if (data.fatal) {
                    switch(data.type) {
                        case Hls.ErrorTypes.NETWORK_ERROR:
                            setStatus(msg + '\n\nRetrying...');
                            hls.startLoad();
                            break;
                        case Hls.ErrorTypes.MEDIA_ERROR:
                            setStatus(msg + '\n\nRecovering...');
                            hls.recoverMediaError();
                            break;
                        default:
                            setStatus(msg + '\n\nCannot recover');
                            hls.destroy();
                            break;
                    }
                }
            });

            setStatus('Using hls.js');
            return;
        }

        setStatus('HLS is not supported in this browser');
    }

    loadBtn.addEventListener('click', () => load(srcInput.value));
    load(defaultSrc);
</script>
</body>
</html>